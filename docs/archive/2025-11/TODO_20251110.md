# 明日待辦事項 - 2025-11-10

**創建日期**: 2025-11-09
**優先級**: P0（緊急）至 P2（一般）
**預估總時間**: 4-6 小時

---

## 🔴 P0 - 緊急任務（必須完成）

### 1. 診斷 Zettelkasten 連結生成失敗問題

**問題**: Jones-2024 測試中，所有卡片的「連結網絡」和「AI notes」都沒有生成連結。

**診斷步驟**:

#### Step 1: 檢查 LLM 原始輸出

```bash
# 修改 generate_jones_2024.py，保存原始 LLM 輸出
# 在 line 74-75 之間添加:
with open('llm_raw_output.txt', 'w', encoding='utf-8') as f:
    f.write(response)

# 重新生成並檢查
python generate_jones_2024.py
cat llm_raw_output.txt | grep -A 5 "連結網絡"
cat llm_raw_output.txt | grep -A 5 "🤖 \*\*AI\*\*"
```

**預期結果**:
- 如果 `llm_raw_output.txt` 中**有**連結 → 問題在解析器
- 如果 `llm_raw_output.txt` 中**沒有**連結 → 問題在 Prompt 或 LLM

#### Step 2: 檢查 zettel_maker.py 解析邏輯

```bash
# 查看解析邏輯
cat src/generators/zettel_maker.py | grep -A 20 "def generate_zettelkasten"
```

**需要確認**:
- [ ] 是否正確解析「連結網絡」區塊
- [ ] 是否正確解析「個人筆記」區塊
- [ ] 是否有正則表達式錯誤
- [ ] 是否保留了 `[[...]]` Wiki Links

#### Step 3: 修復問題

**情境 A**: 如果問題在解析器
- 修復 `zettel_maker.py` 的解析邏輯
- 重新測試 Jones-2024

**情境 B**: 如果問題在 Prompt/LLM
- 繼續執行任務 #2（改進 Prompt）

**預估時間**: 2-3 小時

---

### 2. 改進 Zettelkasten Prompt Template

**目標**: 提高 LLM 生成連結的遵循率

**改進方案**:

#### 改進 1: 開頭明確要求（第 8 行之後）

```jinja2
{% endif %}

**🚨 關鍵要求（請務必遵守）**:
1. ⭐ **每張卡片的「連結網絡」區塊必須包含至少 1 個其他卡片的連結** ⭐
2. ⭐ **每張卡片的「個人筆記 - AI」區塊必須包含至少 1 個 [[cite_key-XXX]] 格式的連結** ⭐
3. 使用格式 `[[Jones-2024-001]]` 來連結其他卡片
4. 連結必須指向真實存在的卡片（在同一批次生成的卡片中）

請為論文「{{ topic }}」創建Zettelkasten原子筆記卡片集...
```

#### 改進 2: 增強 Few-shot 範例

當前只有 2 個範例，增加到 4 個，每個都明確展示連結：

```markdown
===CARD: Jones-2024-001===
...
連結網絡:
- **基於** <- (無前置概念，這是基礎卡片)
- **導向** -> [[Jones-2024-002]], [[Jones-2024-003]]

個人筆記:

🤖 **AI**: 這是論文的核心發現，與 [[Jones-2024-003]] 中討論的多模態語言模型密切相關。值得思考的是...

✍️ **Human**:
===

===CARD: Jones-2024-002===
...
連結網絡:
- **基於** <- [[Jones-2024-001]]
- **導向** -> [[Jones-2024-004]], [[Jones-2024-005]]
- **相關** <-> [[Jones-2024-003]]

個人筆記:

🤖 **AI**: 此概念擴展了 [[Jones-2024-001]] 的理論基礎，但在應用層面需要考慮...

✍️ **Human**:
===

[繼續添加範例 3, 4...]
```

#### 改進 3: 在每個欄位說明中重複要求

```jinja2
連結網絡:
[⭐ 必須包含至少 1 個連結，格式如 [[{{ cite_key }}-001]] ⭐]
- **基於** <- [[{{ cite_key }}-前置ID]]
- **導向** -> [[{{ cite_key }}-延伸ID1]], [[{{ cite_key }}-延伸ID2]]
...

個人筆記:

🤖 **AI**: [批判性思考，⭐ 必須包含至少 1 個 [[{{ cite_key }}-XXX]] 連結 ⭐]

✍️ **Human**:
```

#### 改進 4: 使用系統提示（如果支持）

如果 Gemini API 支持 system message，添加：

```
System: You MUST include at least one [[cite_key-XXX]] link in:
1. The "連結網絡" section of EVERY card
2. The "個人筆記 - 🤖 **AI**" section of EVERY card

This is a critical requirement. Cards without links will be considered invalid.
```

**修改文件**: `templates/prompts/zettelkasten_template.jinja2`

**預估時間**: 1-2 小時

---

## 🟡 P1 - 重要任務（建議完成）

### 3. OpenRouter Rate Limit 重新測試（24 小時後）

**時間**: 2025-11-10 09:30+ (距上次測試 24 小時)

#### Step 1: 快速驗證

```bash
python -c "
from src.generators.slide_maker import SlideMaker
from dotenv import load_dotenv
load_dotenv()

maker = SlideMaker(llm_provider='openrouter')
result = maker.call_llm(
    'Say hello in one word.',
    provider='openrouter',
    model='google/gemini-2.0-flash-exp:free',
    timeout=30
)
print('[OK] Rate limit 已重置！' if result else '[FAIL] 仍然受限')
"
```

#### Step 2: 三模型對比測試（如果 Step 1 成功）

**測試論文**: Jones-2024（與 Google Gemini 版本對比）

```bash
# 使用 test_three_models.py（需要先創建此腳本）
python test_three_models.py --cite-key Jones-2024
```

**三個模型**:
1. `google/gemini-2.0-flash-exp:free` (速度優勢)
2. `deepseek/deepseek-r1:free` (推理優勢)
3. `meta-llama/llama-3.3-70b-instruct:free` (平衡)

**對比維度**:
- AI notes 連結數量
- 連結格式正確性
- 批判性思考質量
- 生成時間

**預估時間**: 2 小時（含分析）

---

### 4. 修復後的驗證測試

**前提**: 任務 #1 和 #2 完成

#### Step 1: 重新生成 Jones-2024

```bash
# 使用修復後的 template 和 parser
python generate_jones_2024.py
```

#### Step 2: 檢查連結

```bash
# 檢查 Wiki Links
grep -r "\[\[Jones-2024-" output/zettelkasten_notes/zettel_Jones-2024_*/zettel_cards/

# 統計連結數量
python analyze_card_links.py

# 預期結果:
# - 明確連結覆蓋率: > 50% (至少 10/20 張卡片)
# - 平均連結數/卡片: > 1.0
```

#### Step 3: 對比新舊結果

| 指標 | 修復前 | 修復後 | 改善 |
|------|-------|-------|------|
| 明確連結覆蓋率 | 0% | ? | ? |
| 平均連結數/卡片 | 0 | ? | ? |
| AI notes 連結數 | 0 | ? | ? |

**預估時間**: 1 小時

---

## 🟢 P2 - 一般任務（時間允許時完成）

### 5. 更新概念網絡分析

**前提**: 有新的 Zettelkasten 卡片生成（含連結）

```bash
# 重新生成概念網絡
python kb_manage.py visualize-network --obsidian \
    --output output/concept_analysis_20251110

# 對比新舊結果
# 舊版: output/concept_analysis/
# 新版: output/concept_analysis_20251110/
```

**關注指標**:
- 高信度關係數 (≥ 0.4): 36,795 → ?
- 建議連結數量: 0 → ?
- 網絡密度變化

**預估時間**: 30 分鐘

---

### 6. 創建 test_three_models.py 腳本

**功能**: 自動化三模型對比測試

```python
#!/usr/bin/env python
"""
三模型對比測試腳本
測試 OpenRouter 上的三個免費模型
"""

import argparse
from pathlib import Path
# ... (參考 regenerate_zettel_with_openrouter.py 的結構)
```

**預估時間**: 1 小時

---

## 📋 工作流程建議

### 上午（9:00-12:00）

1. ☕ **9:00-9:30**: 檢查 OpenRouter Rate Limit（任務 #3）
2. 🔍 **9:30-11:00**: 診斷連結生成問題（任務 #1）
3. ✏️ **11:00-12:00**: 改進 Prompt Template（任務 #2）

### 下午（14:00-18:00）

4. ✅ **14:00-15:00**: 驗證測試（任務 #4）
5. 🎯 **15:00-17:00**: OpenRouter 三模型測試（任務 #3, 如果可用）
6. 📊 **17:00-18:00**: 分析結果和撰寫報告

---

## 🎯 成功標準

### 最小可接受標準（Must Have）

- [ ] 診斷出連結生成失敗的根本原因
- [ ] 修復問題（解析器或 Prompt）
- [ ] 重新生成 Jones-2024，明確連結覆蓋率 > 30%

### 理想標準（Should Have）

- [ ] 明確連結覆蓋率 > 50%
- [ ] 平均連結數/卡片 > 1.5
- [ ] OpenRouter 多模型測試完成
- [ ] 概念網絡分析更新

### 額外加分（Nice to Have）

- [ ] test_three_models.py 腳本完成
- [ ] 撰寫 Phase 2.3 改進實施報告
- [ ] 開始 RelationFinder Phase 2.3 實作

---

## 📚 參考資源

- **今日測試報告**: `PHASE23_TEST_REPORT_20251109.md`
- **恢復指南**: `RESUME_AFTER_RATE_LIMIT.md`
- **Prompt Template**: `templates/prompts/zettelkasten_template.jinja2`
- **解析器代碼**: `src/generators/zettel_maker.py`
- **Phase 2.3 設計**: `docs/RELATION_FINDER_IMPROVEMENTS.md`

---

## ⏰ 檢查清單

出發前確認：

- [ ] 閱讀 `PHASE23_TEST_REPORT_20251109.md`
- [ ] `.env` 文件中 API keys 正確設置
- [ ] 今日生成的測試卡片已備份
- [ ] Git 工作區乾淨（或已 commit）

---

**祝工作順利！** 🚀

如果遇到問題，請記錄到測試報告中，並考慮調整優先級。
