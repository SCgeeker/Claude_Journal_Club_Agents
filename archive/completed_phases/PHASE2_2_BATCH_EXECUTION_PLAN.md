# Phase 2.2 批次執行計畫 - 優化流量和成本控制

**規劃日期**: 2025-11-02
**預算**: Claude Code 200K tokens
**策略**: 分批執行，流量優化
**狀態**: ⏸️ **暫停 - 等待工具改進** (2025-11-04)

---

## ⚠️ 執行狀態更新 (2025-11-04)

### 🔴 計畫暫停

**暫停原因**: Batch C 分析結果遠低於預期，需要改進 Relation_Finder

**Batch C 分析結果**:
```yaml
指標              預期          實際         差距
概念數            100-120      4            ❌ -96%
引用關係          >50          0            ❌ -100%
共同作者對        >20          1            ❌ -95%
```

**根本問題**:
1. 知識庫 keywords 字段不足，無法支持概念提取
2. Jaccard 相似度算法不適合本數據集
3. 缺少向量相似度支持
4. 繼續導入更多論文只會擴大低質量分析

**決策**: 暫停 Phase 2.2，優先改進工具質量

---

### ✅ 已完成部分

```
Batch A:  ✅ 完成 (ZoteroSync 實現)
Batch B1: ✅ 完成 (33篇論文導入)
Batch C:  ✅ 完成 (關係分析，但質量不理想)
```

**成果**:
- 知識庫: 31 → 64 篇論文
- ZoteroSync 工具完成
- Relation_Finder v1 實現（需改進）

---

### ⏸️ 暫停部分

```
Batch B2: ⏸️ 暫停 (第二批導入 27 篇)
Batch B3: ⏸️ 暫停 (第三批導入 27 篇)
Batch D:  ⏸️ 暫停 (最終分析 112 篇)
```

---

### 🔄 新路線圖

**參見**: `PHASE2_REVISED_ROADMAP.md`

**新策略**: 投資改進工具 → 規模化應用

```
Phase 2.3: Zettel 批量生成（64篇）           ← 當前優先級
  ↓
Phase 2.4: Zettel 內容概念提取（800張卡片）
  ↓
Phase 2.5: Relation_Finder v2 重構（多維度相似度）
  ↓
Phase 2.6: 重新分析 64 篇論文（驗證 v2 效果）
  ↓
Phase 2.7: 繼續 Phase 2.2 Batch B2-D         ← 恢復點
           （用高質量工具完成擴展到 112 篇）
```

**恢復條件**:
- ✅ Phase 2.6 驗證通過
- ✅ Relation_Finder v2 所有指標達標
- ✅ 概念提取 >100 個
- ✅ 引用關係 >20 個

**預計恢復時間**: 2025-11-18 ~ 2025-11-24（2-3 週後）

---

### 📊 計畫對比

| 維度 | 原 Phase 2.2 | 修訂計畫 | 差異 |
|------|-------------|---------|------|
| 目標 | 快速擴展到 112 篇 | 先改進工具 | 質量優先 |
| 時間 | 1-2 週 | 2.5-3 週 | +1 週 |
| Token | ~100K | ~145K | +45K |
| 工具質量 | Relation_Finder v1 (低) | Relation_Finder v2 (高) | **可重用** |
| 概念提取 | 10-20 個 | 250-300 個 | **+25x** |
| 引用關係 | 5-10 個 | 80-120 個 | **+16x** |

**結論**: 多投入 1 週和 45K tokens，換取長期高質量工具

---

### 📝 相關文檔

- **新路線圖**: `PHASE2_REVISED_ROADMAP.md` （完整計畫）
- **Phase 2.3 執行計畫**: `PHASE_2_3_EXECUTION_PLAN_20251104.md`
- **Batch C 報告**: `BATCH_C_RELATION_FINDER_COMPLETION_REPORT.md`

---

## 📋 原計畫內容（保留供參考）

以下為原 Phase 2.2 計畫，**暫停執行中**，恢復時參考。

---

## 📊 流量預估和成本分析

### Claude Code Budget 分配

```
總預算: 200,000 tokens (Claude Haiku 4.5)

分配方案:
├─ 歷史對話成本: ~15,000 tokens (已消耗)
├─ 本計畫執行: ~45,000 tokens (預估)
│  ├─ ZoteroSync 開發: 6,000 tokens
│  ├─ 批次導入 × 3: 15,000 tokens (5K each)
│  ├─ Relation-Finder: 6,000 tokens
│  ├─ 驗證和報告: 8,000 tokens
│  └─ 應急和調整: 4,000 tokens
└─ 安全邊界: 140,000 tokens (預留)

使用率: 60,000 / 200,000 = 30% (充分安全)
```

### 每個操作的成本估計

| 操作 | 輸入 Token | 輸出 Token | 總計 |
|------|-----------|-----------|------|
| ZoteroSync 實現 + 測試 | 2,000 | 4,000 | 6,000 |
| 批次 1 導入 (27 篇) | 1,500 | 3,500 | 5,000 |
| 批次 2 導入 (27 篇) | 1,500 | 3,500 | 5,000 |
| 批次 3 導入 (27 篇) | 1,500 | 3,500 | 5,000 |
| Relation-Finder 應用 | 2,000 | 4,000 | 6,000 |
| 驗證和最終報告 | 2,000 | 6,000 | 8,000 |
| **總計** | **10,500** | **24,500** | **35,000** |

---

## 🎯 分批執行計畫

### 執行模式

```
【設計原則】
1. 分批執行 - 每批獨立、可中斷恢復
2. 流量優化 - 每批控制在 5-6K tokens
3. 可驗證 - 每批後有明確驗收標準
4. 並行準備 - 下批工作材料提前準備
```

---

## 📋 完整執行計畫（分 7 個批次）

### 【Batch A】ZoteroSync 核心實現
**目標**: 實現 Zotero 到知識庫的同步框架
**工作時長**: ~6 小時開發
**預計 Token**: ~6,000

#### 工作項目
```
1. 設計 ZoteroSync 類結構
   ├─ BibTeX 解析整合
   ├─ PDF 匹配演算法
   └─ 去重邏輯

2. 實現核心功能 (~250-300 行)
   ├─ parse_bibtex()
   ├─ match_with_kb()
   ├─ resolve_conflicts()
   └─ batch_import()

3. 創建導入腳本
   └─ import_zotero_batch.py (~100 行)

4. 初步測試
   ├─ 單元測試
   └─ 小規模測試導入 (5 篇)
```

#### 交付物
```
✅ src/integrations/zotero_sync.py (完整實現)
✅ import_zotero_batch.py (CLI 工具)
✅ 單元測試通過
✅ 小規模測試報告
```

#### 驗收標準
```
☑️ ZoteroSync 類能正確解析 BibTeX
☑️ 匹配準確度 >95%
☑️ 去重邏輯正確
☑️ 小規模測試 (5 篇) 導入成功
```

#### 執行指令
```bash
# 用戶呼叫: "執行 Batch A: ZoteroSync 實現"

# 預期輸出:
# ✅ ZoteroSync 核心實現完成
# ✅ import_zotero_batch.py 準備就緒
# ✅ 已通過小規模測試 (5 篇論文)
# ✅ 準備進入 Batch B1
```

---

### 【Batch B1】第一批導入 (27 篇)
**目標**: 導入前 40 篇候選論文中可用的 PDF (預估 27 篇)
**工作時長**: ~1-2 小時執行 + 1 小時驗證
**預計 Token**: ~5,000

#### 工作項目
```
1. 準備導入清單
   ├─ 從 final_import_list.json 提取前 40 篇
   ├─ 驗證 PDF 文件可用性
   └─ 生成 batch1_import_list.csv

2. 執行導入
   ├─ 運行 import_zotero_batch.py --batch 1
   ├─ 監控進度和錯誤
   └─ 記錄導入日誌

3. 初步驗證
   ├─ 檢查新論文是否在知識庫中
   ├─ 驗證搜索功能
   └─ 測試搜索延遲 (<150ms?)

4. 品質檢查
   ├─ 運行 python check_quality.py
   ├─ 統計元數據完整度
   └─ 識別問題論文
```

#### 交付物
```
✅ batch1_import_list.csv (40 篇候選)
✅ import_batch1.log (導入日誌)
✅ quality_check_batch1.json (品質報告)
✅ verification_batch1.txt (驗證報告)
```

#### 驗收標準
```
☑️ 導入成功: ≥25 篇 (預期 27 篇)
☑️ 導入失敗: <5 篇
☑️ 新論文在知識庫中
☑️ 搜索延遲: <150ms
☑️ 品質評分: >70/100
☑️ 知識庫規模: 31 → ~58 篇 ✅
```

#### 執行指令
```bash
# 用戶呼叫: "執行 Batch B1: 第一批導入"

# 預期輸出:
# ✅ 導入完成: 27 篇論文
# ✅ 知識庫擴展: 31 → 58 篇
# ✅ 品質評分: 75/100
# ✅ 搜索延遲: 135ms
# ✅ 準備進入 Batch C
```

---

### 【Batch C】Relation-Finder 應用和分析
**目標**: 對新導入論文應用 Relation-Finder 進行關係分析
**工作時長**: ~2-3 小時分析
**預計 Token**: ~6,000

#### 工作項目
```
1. 運行 Relation-Finder
   ├─ 對所有 58 篇論文進行分析 (31 + 27)
   ├─ 生成引用網絡
   ├─ 更新共著者網絡
   ├─ 計算概念共現
   └─ 構建時間軸

2. 驗證和優化
   ├─ 檢查新作者和概念
   ├─ 驗證知識圖譜品質
   └─ 更新統計指標

3. 生成報告
   ├─ 關係分析報告
   ├─ 新增作者和概念統計
   └─ 知識圖譜視覺化更新
```

#### 交付物
```
✅ relations_batch1.json (關係分析)
✅ coauthor_network_update.json (新的共著者網絡)
✅ concept_updates.json (新的概念分析)
✅ relation_analysis_batch1_report.md (報告)
```

#### 驗收標準
```
☑️ Relation-Finder 成功運行
☑️ 新作者統計: ~150-180 位 (預期)
☑️ 新概念統計: ~100-120 個 (預期)
☑️ 知識圖譜更新成功
☑️ 無數據不一致
```

#### 執行指令
```bash
# 用戶呼叫: "執行 Batch C: Relation-Finder 分析"

# 預期輸出:
# ✅ Relation-Finder 分析完成
# ✅ 新作者: 156 位 (+57 位)
# ✅ 新概念: 108 個 (+31 個)
# ✅ 知識圖譜更新完成
# ✅ 準備進入 Batch B2
```

---

### 【Batch B2】第二批導入 (27 篇)
**目標**: 導入篇 41-80 的候選論文中可用的 PDF (預估 27 篇)
**工作時長**: ~1-2 小時執行 + 1 小時驗證
**預計 Token**: ~5,000

#### 工作項目
```
1. 準備導入清單
   ├─ 從 final_import_list.json 提取篇 41-80
   ├─ 驗證 PDF 文件可用性
   └─ 生成 batch2_import_list.csv

2. 執行導入
   ├─ 運行 import_zotero_batch.py --batch 2
   ├─ 監控和日誌記錄
   └─ 去重檢查 (防止重複導入)

3. 驗證
   ├─ 搜索功能驗證
   ├─ 搜索延遲檢查
   └─ 去重有效性驗證

4. 品質檢查
   ├─ python check_quality.py
   ├─ 累計統計 (58 + 27 = ~85)
   └─ 問題識別和記錄
```

#### 交付物
```
✅ batch2_import_list.csv (40 篇候選)
✅ import_batch2.log (導入日誌)
✅ quality_check_batch2.json (品質報告)
✅ verification_batch2.txt (驗證報告)
✅ deduplication_report.txt (去重報告)
```

#### 驗收標準
```
☑️ 導入成功: ≥25 篇
☑️ 去重有效率: >95%
☑️ 搜索延遲: <160ms (允許小幅增加)
☑️ 品質評分: >75/100
☑️ 知識庫規模: 58 → ~85 篇 ✅
```

#### 執行指令
```bash
# 用戶呼叫: "執行 Batch B2: 第二批導入"

# 預期輸出:
# ✅ 導入完成: 27 篇論文
# ✅ 去重結果: 0 重複
# ✅ 知識庫擴展: 58 → 85 篇
# ✅ 品質評分: 76/100
# ✅ 搜索延遲: 145ms
# ✅ 準備進入 Batch B3
```

---

### 【Batch B3】第三批導入 (27 篇)
**目標**: 導入篇 81-120 的候選論文中可用的 PDF (預估 27 篇)
**工作時長**: ~1-2 小時執行 + 1 小時驗證
**預計 Token**: ~5,000

#### 工作項目
```
1. 準備導入清單
   ├─ 從 final_import_list.json 提取篇 81-120
   ├─ 驗證 PDF 文件可用性
   └─ 生成 batch3_import_list.csv

2. 執行導入
   ├─ 運行 import_zotero_batch.py --batch 3
   ├─ 最後一批導入監控
   └─ 完整日誌記錄

3. 完整驗證
   ├─ 全知識庫搜索測試
   ├─ 批量搜索效能測試
   └─ 索引完整性驗證

4. 最終品質檢查
   ├─ python check_quality.py (全庫)
   ├─ 統計全庫統計數據
   └─ 問題報告和修復建議
```

#### 交付物
```
✅ batch3_import_list.csv (40 篇候選)
✅ import_batch3.log (導入日誌)
✅ quality_check_final.json (最終品質報告)
✅ verification_batch3.txt (驗證報告)
✅ final_statistics.txt (最終統計)
```

#### 驗收標準
```
☑️ 導入成功: ≥25 篇
☑️ 去重有效率: >95%
☑️ 搜索延遲: <160ms
☑️ 品質評分: >75/100 (全庫平均)
☑️ 知識庫規模: 85 → ~112 篇 ✅ (達到目標!)
```

#### 執行指令
```bash
# 用戶呼叫: "執行 Batch B3: 第三批導入"

# 預期輸出:
# ✅ 導入完成: 27 篇論文
# ✅ 知識庫擴展: 85 → 112 篇 ✅
# ✅ 品質評分: 77/100
# ✅ 搜索延遲: 148ms
# ✅ 所有導入批次完成!
# ✅ 準備進入 Batch D
```

---

### 【Batch D】最終 Relation-Finder 應用和知識圖譜更新
**目標**: 最終的全庫關係分析和知識圖譜更新
**工作時長**: ~2-3 小時分析
**預計 Token**: ~6,000

#### 工作項目
```
1. 完整 Relation-Finder 運行
   ├─ 對全 112 篇論文進行完整分析
   ├─ 生成最終引用網絡
   ├─ 構建完整共著者網絡
   ├─ 完整概念共現分析
   └─ 完整時間軸分析

2. 知識圖譜生成
   ├─ Mermaid 圖表生成
   ├─ 可視化輸出
   └─ 統計圖表生成

3. 最終報告生成
   ├─ Phase 2.2 完成報告
   ├─ 統計摘要
   ├─ 發現和洞察
   └─ 後續建議
```

#### 交付物
```
✅ relations_final.json (最終關係分析)
✅ coauthor_network_final.md (Mermaid 圖表)
✅ concept_network_final.md (概念網絡圖表)
✅ timeline_final.md (時間軸)
✅ PHASE2_2_COMPLETION_REPORT.md (完成報告)
```

#### 驗收標準
```
☑️ Relation-Finder 完整運行成功
☑️ 最終統計:
   - 論文: 112 篇 (從 31 篇, +3.6 倍) ✅
   - 作者: ~320-350 位 (從 99 位) ✅
   - 概念: ~220-250 個 (從 73 個) ✅
☑️ 知識圖譜完整更新
☑️ 所有文檔已生成和版本化
```

#### 執行指令
```bash
# 用戶呼叫: "執行 Batch D: 最終關係分析和報告"

# 預期輸出:
# ✅ 最終 Relation-Finder 分析完成
# ✅ 最終統計:
#    - 論文: 112 篇 (+81 篇, +3.6 倍)
#    - 作者: 348 位 (+249 位, +3.5 倍)
#    - 概念: 236 個 (+159 個, +3.1 倍)
# ✅ 知識圖譜已更新並可視化
# ✅ Phase 2.2 完成! 🎉
```

---

## 📅 執行時間表

### 推薦執行節奏

```
【第一週】
Day 1 (明天, 2025-11-03):
  ├─ 09:00 - 呼叫 "執行 Batch A" (ZoteroSync)
  ├─ 17:00 - Batch A 應該完成
  └─ 晚上: 驗證 Batch A 輸出

Day 2 (2025-11-04):
  ├─ 09:00 - 呼叫 "執行 Batch B1" (第一批導入)
  ├─ 12:00 - Batch B1 應該完成
  └─ 下午: 驗證 Batch B1

Day 3 (2025-11-05):
  ├─ 09:00 - 呼叫 "執行 Batch C" (Relation-Finder)
  ├─ 17:00 - Batch C 應該完成
  └─ 晚上: 準備 Batch B2

【第二週】
Day 1 (2025-11-10):
  ├─ 09:00 - 呼叫 "執行 Batch B2" (第二批導入)
  ├─ 12:00 - Batch B2 完成
  └─ 下午: 驗證 Batch B2

Day 2 (2025-11-11):
  ├─ 09:00 - 呼叫 "執行 Batch B3" (第三批導入)
  ├─ 12:00 - Batch B3 完成
  └─ 下午: 驗證 Batch B3

Day 3 (2025-11-12):
  ├─ 09:00 - 呼叫 "執行 Batch D" (最終分析和報告)
  ├─ 17:00 - Batch D 完成
  └─ 🎉 Phase 2.2 完成!
```

### 總時間投入

```
開發工作:
├─ Batch A: 6 小時 (開發)
├─ Batch B1: 2-3 小時 (執行+驗證)
├─ Batch C: 2-3 小時 (分析)
├─ Batch B2: 2-3 小時 (執行+驗證)
├─ Batch B3: 2-3 小時 (執行+驗證)
└─ Batch D: 2-3 小時 (分析+報告)
                  ─────────────
                  約 18-22 小時 (分散執行)

流量消耗:
└─ 總計: ~35,000 tokens (在 200K 預算內) ✅
```

---

## 💾 執行檢查清單

### Batch A 前準備
```
[ ] 確認 ZoteroSync 需求清晰
[ ] 確認 src/integrations/ 目錄存在
[ ] 確認現有 bibtex_parser.py 可用
[ ] 準備測試用 5 篇 PDF 文件
```

### Batch B1-B3 通用準備
```
[ ] 確認 knowledge_base/index.db 已備份
[ ] 確認 final_import_list.json 準備好
[ ] 確認 check_quality.py 可運行
[ ] 準備監控搜索延遲的測試
```

### Batch C & D 前準備
```
[ ] 確認 Relation-Finder 代碼可運行
[ ] 準備 Mermaid 輸出目錄
[ ] 準備統計分析腳本
```

---

## 📊 流量監控

### 每個 Batch 的成本監控

```
Batch A: 6,000 tokens
├─ 運行中…
└─ 完成: 5,827 tokens ✅

Batch B1: 5,000 tokens
├─ 運行中…
└─ 預估完成

Batch C: 6,000 tokens
├─ 待執行…
└─ 預估完成

...

總預算: 200,000 tokens
已使用: ~15,000 tokens (歷史)
本計畫: ~35,000 tokens
剩餘: ~150,000 tokens ✅ (充裕)
```

---

## 🎯 成功標準

### 全流程成功標準

```
✅ Batch A 完成
   └─ ZoteroSync 實現完整，通過小規模測試

✅ Batch B1-B3 完成
   └─ 共導入 ~81 篇論文，知識庫從 31 → 112 篇

✅ Batch C & D 完成
   └─ 知識圖譜完整更新，所有統計完成

📊 最終成果
   └─ 知識庫規模: 112 篇 (+3.6 倍)
   └─ 作者數: ~348 位 (+3.5 倍)
   └─ 概念數: ~236 個 (+3.1 倍)
   └─ 搜索延遲: <160ms
   └─ 品質評分: >77/100
```

---

## 📞 執行呼叫方式

### 標準呼叫格式

```
用戶呼叫:
"執行 Batch A: ZoteroSync 核心實現"

我的回應:
✅ Batch A 執行開始
   [開發 ZoteroSync...]
   [測試...]
   [驗證...]
✅ Batch A 執行完成
   - 交付物: src/integrations/zotero_sync.py 等
   - 驗收: 通過 ✅
   - 下步: 準備 Batch B1
```

### 快速參考

```
常用呼叫命令:
1. "執行 Batch A: ZoteroSync 實現"
2. "執行 Batch B1: 第一批導入"
3. "執行 Batch C: Relation-Finder 分析"
4. "執行 Batch B2: 第二批導入"
5. "執行 Batch B3: 第三批導入"
6. "執行 Batch D: 最終分析和報告"

或簡化:
1. "Batch A"
2. "Batch B1"
3. 等等...
```

---

## 🚨 應急計畫

### 如果某個 Batch 失敗

```
【Batch A 失敗】
└─ 根本問題: ZoteroSync 實現有 bug
   → 重新呼叫 "執行 Batch A" 進行修復
   → 或分步驟執行: "修復 ZoteroSync match 邏輯"

【Batch B 導入失敗】
└─ 根本問題: 部分 PDF 不可用或格式問題
   → 重新呼叫 "執行 Batch B[X]"
   → 或手動跳過問題論文，重新導入
   → 或下調批次大小 (減少導入數)

【Batch C 分析失敗】
└─ 根本問題: 知識庫不一致
   → 回滾到最近的備份
   → 重新運行最後一個成功的 Batch
   → 然後重新呼叫 Batch C

【流量用盡】
└─ 應該不會發生 (35K vs 200K 的預算)
   → 但如果發生: 等待下一個新會話/新配額
```

---

## 📋 完整批次摘要表

| Batch | 名稱 | 工作時長 | Token | 預期輸入 | 預期輸出 |
|-------|------|---------|-------|--------|--------|
| **A** | ZoteroSync 實現 | 6小時 | 6K | 設計+代碼 | zotero_sync.py |
| **B1** | 第一批導入 (27篇) | 2-3小時 | 5K | 導入清單 | 27篇導入 + 報告 |
| **C** | Relation-Finder | 2-3小時 | 6K | 58篇論文 | 關係分析+圖表 |
| **B2** | 第二批導入 (27篇) | 2-3小時 | 5K | 導入清單 | 27篇導入 + 報告 |
| **B3** | 第三批導入 (27篇) | 2-3小時 | 5K | 導入清單 | 27篇導入 + 報告 |
| **D** | 最終分析 | 2-3小時 | 6K | 112篇論文 | 最終報告 + 圖表 |
| **總計** | | 18-22小時 | 35K | - | **112篇 KB** |

---

## 🎉 完成後

### Phase 2.2 完成時會有

```
✅ 知識庫擴展
   ├─ 31 → 112 篇論文 (+3.6 倍)
   ├─ 99 → 348 位作者 (+3.5 倍)
   └─ 73 → 236 個概念 (+3.1 倍)

✅ 完整文檔
   ├─ PHASE2_2_COMPLETION_REPORT.md
   ├─ 所有批次執行日誌
   ├─ 統計報告
   └─ 知識圖譜視覺化

✅ 系統改進
   ├─ ZoteroSync 實現完整
   ├─ 批次導入框架確立
   ├─ 自動化品質檢查
   └─ 關係分析集成

⏳ 可進入 Phase 2.3
   └─ 知識庫架構適配層實現
   └─ 向量搜索優化
   └─ 知識圖譜視覺化增強
```

---

**計畫完成**: 2025-11-02 23:55
**狀態**: ✅ 準備就緒，等待執行指令
**下步**: 用戶呼叫 "執行 Batch A" 啟動 Phase 2.2

