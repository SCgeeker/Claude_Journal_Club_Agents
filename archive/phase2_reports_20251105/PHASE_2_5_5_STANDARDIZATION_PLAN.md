# Phase 2.5.5 - Zettelkasten 格式標準化計畫

**日期**: 2025-11-04
**狀態**: 規劃與執行中
**預計耗時**: 3-4 小時

---

## 1. 現狀分析

### 卡片格式分布

```
總卡片數: 704 張

格式分類:
  - 標準格式 (Author-Year-Number):        608 張 (86.3%)
    例: Wu-2020-001, Abbas-2022-012

  - 版本後綴格式 (Author-Year+suffix):     96 張 (13.6%)
    例: Chen-2023c-001, Her-2012a-005
    代表同一論文的不同版本

  - 舊格式 (Domain-Date-Number):            0 張 (已全部刪除)

  - 未知格式:                               0 張
```

### 資料庫狀態

```
zettel_cards 記錄:           576 條
  - 標準格式卡片:           564 條 (98%)
  - 版本後綴卡片:            12 條 (2%)

已鏈接到論文:               576 條 (100%)
  - 標準格式成功率:        100%
  - 版本後綴成功率:        100%

✓ 所有卡片都已成功鏈接到論文!
```

---

## 2. 標準化目標

### 目標定義

定義統一的 Zettelkasten 卡片ID格式標準:

```
新標準正則表達式:
  ^[A-Za-z]+-\d+(?:[a-z])?-\d{3}$

說明:
  - [A-Za-z]+      : 作者名 (1個或多個字母)
  - -\d+           : 年份 (4位數字)
  - (?:[a-z])?     : 版本後綴 (可選，單一小寫字母 a-z)
  - -\d{3}         : 序號 (3位數字)

符合格式的例子:
  ✓ Wu-2020-001        (標準)
  ✓ Chen-2023c-001     (有版本後綴)
  ✓ Her-2012b-010      (有版本後綴)
  ✗ Linguistics-20251029-001 (舊格式 - 已刪除)
```

### 標準化益處

1. **統一性**
   - 單一明確的格式定義
   - 無岐義，易於解析

2. **包容性**
   - 支援同一論文的多版本
   - 保留版本資訊的語義意義

3. **向後相容**
   - 現有卡片 100% 符合
   - 無需格式轉換

---

## 3. 實施步驟

### Step 1: 更新 Relation_Finder 正則表達式

**檔案**: `src/analyzers/relation_finder.py`

**現狀代碼** (第 490 行):
```python
# 新格式: Author-Year-Number (如 "Ahrens-2016-001" → "Ahrens-2016")
match = re.match(r'^([A-Za-z]+-\d+)-\d{3}$', card_id)
```

**更新為**:
```python
# 新標準格式: Author-Year[+suffix]-Number
# 支援: Wu-2020-001 (標準) 和 Chen-2023c-001 (版本後綴)
match = re.match(r'^([A-Za-z]+-\d+(?:[a-z])?)-\d{3}$', card_id)
```

**變更說明**:
- `(?:[a-z])?` 表示可選的單一小寫字母版本後綴
- 當 cite_key 提取時，保留版本後綴 (e.g., Her-2012a, not Her-2012)
- 向後相容: 標準格式 Author-Year 仍符合

### Step 2: 更新相關檢查和文檔

**檔案**: 各種相關程式碼和註釋

**更新項目**:

1. `_parse_card_frontmatter()` 文檔
   ```python
   def _parse_card_frontmatter(self, content: str) -> Dict:
       """解析 Markdown 卡片的 YAML frontmatter

       支援的卡片ID格式 (新標準):
         - 標準格式: Author-Year-Number (e.g., Wu-2020-001)
         - 版本後綴: Author-Year[a-z]-Number (e.g., Her-2012a-001)
       """
   ```

2. `extract_cite_key_from_card_id()` 文檔
   ```python
   def extract_cite_key_from_card_id(self, card_id: str, ...) -> Optional[str]:
       """從卡片 ID 提取 cite_key - 新標準格式

       支援:
         - Wu-2020-001 → "Wu-2020"
         - Her-2012a-001 → "Her-2012a"
       """
   ```

3. 移除舊格式相容註釋
   - 刪除所有提到 "Domain-Date-Number" 的註釋
   - 刪除所有提到 "舊格式" 的 if-else 分支

### Step 3: 代碼清理

**目標**: 移除不必要的舊格式相容代碼

**要移除的部分** (在 relation_finder.py 中):

```python
# 移除這些舊格式相容代碼:

# 1. 舊的正則匹配 (第 495-500 行)
# 舊格式: Domain-Date-Number (如 "Linguistics-20251104-001")
if re.match(r'^[A-Za-z]+-\d{8}-\d{3}$', card_id):
    if folder_name:
        cite_key = self._extract_cite_key_from_folder(folder_name)
        if cite_key:
            return cite_key
    return None

# 2. _extract_cite_key_from_folder() 方法 (可能可以簡化)
def _extract_cite_key_from_folder(self, folder_name: str) -> Optional[str]:
    """已不需要 - 新標準格式卡片ID包含完整cite_key"""
```

**保留的部分**:
- 新標準正則表達式
- 資料庫查詢邏輯
- 概念提取邏輯

### Step 4: 測試與驗證

#### 4.1 單元測試

```python
def test_cite_key_extraction():
    """測試新標準格式的 cite_key 提取"""

    test_cases = [
        # (card_id, expected_cite_key)
        ("Wu-2020-001", "Wu-2020"),
        ("Chen-2023c-001", "Chen-2023c"),
        ("Her-2012a-010", "Her-2012a"),
        ("Abbas-2022-012", "Abbas-2022"),
        ("Jones-2024a-005", "Jones-2024a"),
    ]

    for card_id, expected in test_cases:
        result = extract_cite_key_from_card_id(card_id)
        assert result == expected, f"Failed for {card_id}"
```

#### 4.2 完整系統測試

```bash
# 重新運行 Phase 2.5 Zettel Linker
python src/analyzers/relation_finder.py --phase2-5

# 預期結果:
#   - 576/576 cards linked (100%)
#   - 271 concepts extracted
#   - 0 failures
```

#### 4.3 驗證清單

- [ ] 608 張標準格式卡片: 100% 成功鏈接
- [ ] 96 張版本後綴卡片: 100% 成功鏈接  (現況: 12 張已在DB)
- [ ] 資料庫完整性: 無資料遺失
- [ ] 概念提取: 271 個概念保留
- [ ] 舊代碼: 全部移除或清理

---

## 4. 實施計畫

### 時間表

```
總耗時: 3-4 小時

時間分配:
  - 代碼審查: 30 分鐘
  - 正則表達式更新: 30 分鐘
  - 舊代碼移除: 1 小時
  - 文檔更新: 30 分鐘
  - 測試與驗證: 1 小時
```

### 實施順序

```
1. [分析] ✓ 已完成 - 確認現狀
2. [規劃] ✓ 已完成 - 制定計畫 (本文檔)
3. [開發] → 下一步 - 更新代碼
   a. 備份 relation_finder.py
   b. 更新正則表達式
   c. 移除舊格式代碼
   d. 更新文檔和註釋
4. [測試] → 驗證功能
   a. 運行 Phase 2.5 Zettel Linker
   b. 檢查 100% 成功率
   c. 驗證資料庫一致性
5. [完成] → 清理和發布
   a. 生成最終報告
   b. 更新 CLAUDE.md
   c. Git commit
```

---

## 5. 代碼變更摘要

### 要變更的檔案

```
src/analyzers/relation_finder.py
  - 第 490 行: 更新正則表達式
  - 第 495-500 行: 移除舊格式匹配邏輯
  - 各處: 更新註釋和文檔
  - 可選: 簡化 _extract_cite_key_from_folder() 方法
```

### 代碼變更清單

```
變更類型       | 數量 | 影響
--------------|------|-------
正則表達式更新 |  1   | 關鍵
代碼移除       |  5-8 | 中等
文檔更新       | 3-5  | 低
新增測試       |  1   | 品質
```

### 複雜性評估

```
難度: 低 - 中等
  - 正則表達式變更簡單明確
  - 舊代碼移除無需替換邏輯
  - 無需資料庫遷移

風險: 低
  - 新標準 100% 向後相容
  - 所有卡片已符合新標準
  - 可輕易回滾
```

---

## 6. 預期成果

### 代碼層面

```
程式碼行數:
  刪除: 30-50 行 (舊格式相容代碼)
  增加: 5-10 行 (文檔和測試)
  淨變化: -25-45 行

可維護性提升:
  - 條件分支減少: 15-20%
  - 代碼清晰度提升: 明顯
  - 技術債減少: 中等
```

### 系統層面

```
功能:
  - Zettel-論文鏈接成功率: 100% (維持)
  - 概念提取品質: 優秀 (維持)
  - 版本卡片支援: 正式標準化

性能:
  - 掃描速度: 無變化
  - 記憶體使用: 無變化
  - 資料庫查詢: 無變化
```

### 文檔層面

```
更新項目:
  - CLAUDE.md (Relation_Finder 部分)
  - relation_finder.py (程式碼註釋)
  - 本計畫文檔轉為完成報告

新增文檔:
  - Phase 2.5.5 完成報告
  - 標準格式定義 (可選)
```

---

## 7. 驗收標準

### 功能驗收

- [ ] 所有 576 張卡片 100% 成功鏈接
- [ ] 新標準正則表達式通過所有測試
- [ ] 版本後綴卡片正確處理
- [ ] 資料庫記錄無遺漏或損壞

### 品質驗收

- [ ] 代碼複查通過
- [ ] 未移除的舊代碼註釋已更新
- [ ] 文檔與代碼一致
- [ ] 無新增技術債

### 完成度驗收

- [ ] Phase 2.5.5 計畫 100% 實施
- [ ] 測試報告完整
- [ ] Git 提交紀錄清晰
- [ ] 知識庫已更新

---

## 8. 風險和應變

### 潛在風險

| 風險 | 機率 | 影響 | 應變方案 |
|------|------|------|---------|
| 正則表達式錯誤 | 低 | 中 | 完整測試 |
| 舊代碼移除不完全 | 低 | 低 | 代碼審查 |
| 資料庫不一致 | 極低 | 高 | 備份和回滾 |
| 版本卡片遺漏 | 低 | 中 | 額外驗證 |

### 應變計畫

```
若發生問題:
  1. 立即停止
  2. 恢復備份
  3. 檢查變更
  4. 重新測試
  5. 保留失敗日誌供分析
```

---

## 9. 決策記錄

### 格式標準化決策

**決定**: 採用 OPTION C - 統一支援兩種格式

**理由**:
1. 版本後綴具有語義意義 (代表不同版本)
2. 現有 96 張卡片已使用此格式
3. 所有卡片已 100% 成功鏈接
4. 無需進行破壞性的格式轉換
5. 正則表達式的調整簡單明確

**文檔**: 本計畫第 2 節「現狀分析」和第 2 節「標準化目標」

---

## 10. 簽核檢查表

| 項目 | 狀態 | 負責人 | 備註 |
|------|------|--------|------|
| 規劃審批 | ⏳ 待執行 | Claude | 本文檔 |
| 代碼審查 | ⏳ 待執行 | Claude | 變更前 |
| 測試執行 | ⏳ 待執行 | Claude | 變更後 |
| 完成驗收 | ⏳ 待執行 | Claude | 全部通過 |

---

**下一步**: 開始 Step 1 - 代碼審查和備份

